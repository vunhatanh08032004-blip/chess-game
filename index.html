<!DOCTYPE html>
<html>
<head>
    <title>Chess Master PVP - Realtime</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <style>
        body { background: #1a1a1a; color: white; font-family: 'Segoe UI', Arial; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        /* Hiệu ứng xám khi dừng/chờ */
        #game-view-container { transition: all 0.4s; filter: grayscale(100%); opacity: 0.3; pointer-events: none; }
        .is-active { filter: grayscale(0%) !important; opacity: 1 !important; pointer-events: auto !important; }

        #main-layout { display: flex; gap: 20px; background: #262626; padding: 20px; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #game-outer { position: relative; width: 450px; height: 450px; border: 2px solid #333; }
        #board { width: 100%; height: 100%; }
        
        #click-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr); z-index: 100; cursor: pointer; }
        .click-cell { width: 100%; height: 100%; box-sizing: border-box; border: 3px solid transparent; }
        .border-selected { border: 4px solid #ffff00 !important; z-index: 110; } 
        .border-hint { border: 4px solid #00ff00 !important; z-index: 110; }     
        
        #logs-container { width: 250px; display: flex; flex-direction: column; }
        #logs { flex-grow: 1; background: #000; color: #0f0; padding: 10px; font-family: monospace; height: 400px; overflow-y: auto; border: 1px solid #444; font-size: 12px; }
        
        .info-bar { margin: 10px 0; padding: 10px; background: #111; text-align: center; color: #00ffcc; font-weight: bold; border-radius: 4px; }
        #timer-span { color: #ff4d4d; margin-left: 10px; display: none; }
        
        /* Modal & Nút X */
        #modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; }
        .system-modal { display: none; position: fixed; top:50%; left:50%; transform:translate(-50%, -50%); width: 420px; background: #f0f0f0; border: 2px solid #0055ea; z-index: 2001; color: #000; }
        .modal-header { background: #0055ea; color: white; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .close-x { cursor: pointer; font-size: 24px; line-height: 1; font-weight: bold; }
        .modal-body { padding: 30px; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .modal-footer { padding: 15px; background: #eee; display: flex; justify-content: center; gap: 10px; border-top: 1px solid #ccc; }
        .modal-btn { padding: 10px 20px; cursor: pointer; font-weight: bold; min-width: 100px; }

        .top-controls { margin-bottom: 20px; }
        .mode-btn { padding: 12px 25px; cursor: pointer; font-weight: bold; background: #444; color: #ccc; border: none; margin: 0 5px; }
        .mode-btn.active { background: #007acc; color: white; }
        .mode-btn.disabled { filter: grayscale(100%); opacity: 0.3; pointer-events: none; }
    </style>
</head>
<body>

    <div class="top-controls" id="nav">
        <button class="mode-btn" id="btn-pve" onclick="requestGame('PVE')">NGƯỜI VS MÁY</button>
        <button class="mode-btn" id="btn-pvp" onclick="requestGame('PVP')">NGƯỜI VS NGƯỜI</button>
    </div>

    <div id="game-view-container">
        <div id="main-layout">
            <div>
                <div id="game-outer">
                    <div id="board"></div>
                    <div id="click-overlay"></div>
                </div>
                <div class="info-bar">
                    <span id="turn-display">LƯỢT ĐI: TRẮNG</span>
                    <span id="timer-span">30s</span>
                </div>
            </div>
            <div id="side-panel">
                <div id="logs-container">
                    <div id="logs">> Đang kết nối Firebase...</div>
                    <button onclick="confirmExit()" style="margin-top:10px; background:#e74c3c; color:white; border:none; padding:12px; cursor:pointer; font-weight:bold; width:100%;">THOÁT TRẬN</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-overlay"></div>
    <div id="custom-modal" class="system-modal">
        <div class="modal-header">
            <span>THÔNG BÁO HỆ THỐNG</span>
            <span class="close-x" onclick="closeSystemModal()">×</span>
        </div>
        <div class="modal-body">
            <div id="modal-msg" style="font-weight:bold; font-size:16px;"></div>
        </div>
        <div class="modal-footer" id="modal-btns"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

    <script>
        // Cấu hình Firebase của bạn
        const firebaseConfig = {
            apiKey: "AIzaSyCJRXRhYXBbc0DiwZg3KXnySGJ63z4Ow2s",
            authDomain: "chessonline-43534.firebaseapp.com",
            databaseURL: "https://chessonline-43534-default-rtdb.firebaseio.com",
            projectId: "chessonline-43534",
            storageBucket: "chessonline-43534.firebasestorage.app",
            messagingSenderId: "194591877060",
            appId: "1:194591877060:web:4d9461cbebfc3184eb2691"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        var board = null, game = new Chess(), selectedSq = null;
        var mode = '', myColor = 'w', timer = 30, timerInt = null, isPaused = false;
        var roomId = "global_match"; 

        function triggerModal(msg, btns) {
            isPaused = true;
            $('#modal-msg').html(msg);
            $('#modal-btns').html(btns.map(b => `<button class="modal-btn" onclick="${b.fn}">${b.txt}</button>`).join(''));
            $('#modal-overlay, #custom-modal').show();
            $('#game-view-container').css('filter', 'grayscale(100%)').css('opacity', '0.3');
        }

        function closeSystemModal() {
            $('#modal-overlay, #custom-modal').hide();
            if (mode) { 
                isPaused = false; 
                $('#game-view-container').css('filter', 'grayscale(0%)').css('opacity', '1');
                startCountdown(); 
            }
        }

        function startCountdown() {
            clearInterval(timerInt);
            timer = 30;
            $('#timer-span').show().text(timer + "s");
            timerInt = setInterval(() => {
                if (!isPaused) {
                    timer--;
                    $('#timer-span').text(timer + "s");
                    if (timer <= 0) { 
                        clearInterval(timerInt);
                        if(mode === 'PVE') aiMove(true);
                    }
                }
            }, 1000);
        }

        function requestGame(m) {
            $('.mode-btn').addClass('disabled');
            $(`#btn-${m.toLowerCase()}`).removeClass('disabled').addClass('active');

            if (m === 'PVP') {
                triggerModal("Đang chờ người chơi khác chọn PVP...", []);
                // Logic PVP: Kiểm tra phòng
                db.ref('matchmaking').once('value', snapshot => {
                    let val = snapshot.val();
                    if (!val) {
                        myColor = 'w';
                        db.ref('matchmaking').set({ p1: true });
                        db.ref('matchmaking').on('value', s => {
                            if (s.val().p2) {
                                db.ref('matchmaking').off();
                                triggerModal("Đã có đối thủ!", [{txt: "Vào trận", fn: "initGame('PVP')"}]);
                            }
                        });
                    } else {
                        myColor = 'b';
                        db.ref('matchmaking').update({ p2: true });
                        triggerModal("Đối thủ đã sẵn sàng!", [{txt: "Vào trận", fn: "initGame('PVP')"}]);
                    }
                });
            } else {
                triggerModal("Bạn đấu với Máy AI (1-10s)", [{txt: "Bắt đầu", fn: "initGame('PVE')"}]);
            }
        }

        function initGame(m) {
            mode = m;
            closeSystemModal();
            game.reset();
            
            if (m === 'PVE') myColor = Math.random() > 0.5 ? 'w' : 'b';
            
            board.orientation(myColor === 'w' ? 'white' : 'black');
            board.start();
            drawClickGrid();
            
            if (m === 'PVP') {
                db.ref('game').set({ fen: 'start' });
                db.ref('game').on('value', snap => {
                    let f = snap.val().fen;
                    if (f !== game.fen()) {
                        game.load(f);
                        board.position(f);
                        refreshStatus();
                    }
                });
            }
            
            refreshStatus();
            if (myColor === 'b' && m === 'PVE') aiMove();
        }

        function aiMove(instant = false) {
            if (game.game_over()) return;
            let delay = instant ? 500 : (Math.floor(Math.random() * 9000) + 1000);
            setTimeout(() => {
                if (isPaused) return;
                let moves = game.moves();
                game.move(moves[Math.floor(Math.random() * moves.length)]);
                board.position(game.fen());
                refreshStatus();
            }, delay);
        }

        $(document).on('click', '.click-cell', function() {
            if (game.turn() !== myColor || isPaused) return;
            let sq = $(this).data('sq');
            if (selectedSq) {
                let m = game.move({ from: selectedSq, to: sq, promotion: 'q' });
                if (m) {
                    board.position(game.fen());
                    if (mode === 'PVP') db.ref('game').update({ fen: game.fen() });
                    selectedSq = null; $('.click-cell').removeClass('border-selected border-hint');
                    refreshStatus();
                    if (mode === 'PVE') aiMove();
                } else { highlight(sq); }
            } else { highlight(sq); }
        });

        function highlight(sq) {
            let p = game.get(sq);
            if (p && p.color === myColor && p.color === game.turn()) {
                selectedSq = sq;
                $('.click-cell').removeClass('border-selected border-hint');
                $(`#sq-${sq}`).addClass('border-selected');
                game.moves({square: sq, verbose: true}).forEach(m => $(`#sq-${m.to}`).addClass('border-hint'));
            }
        }

        function refreshStatus() {
            let t = game.turn() === 'w' ? "TRẮNG" : "ĐEN";
            $('#turn-display').text("LƯỢT ĐI: " + t);
            if (game.game_over()) triggerModal("KẾT THÚC!", [{txt: "Làm mới", fn: "location.reload()"}]);
            else startCountdown();
        }

        function drawClickGrid() {
            $('#click-overlay').empty();
            let squares = [];
            for (let i = 8; i >= 1; i--) for (let j = 0; j < 8; j++) squares.push(String.fromCharCode(97 + j) + i);
            if (myColor === 'b') squares.reverse();
            squares.forEach(s => $('#click-overlay').append(`<div class="click-cell" id="sq-${s}" data-sq="${s}"></div>`));
        }

        function addLog(m) { $('#logs').append(`<div>> ${m}</div>`).scrollTop($('#logs')[0].scrollHeight); }
        function confirmExit() { triggerModal("Thoát trận?", [{txt: "Có", fn: "location.reload()"}, {txt: "Không", fn: "closeSystemModal()"}]); }

        board = Chessboard('board', { position: 'start', draggable: false, pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' });
        addLog("Firebase đã sẵn sàng.");
    </script>
</body>
</html>
