<!DOCTYPE html>
<html>
<head>
    <title>Chess Online - 2 Game Modes</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body {
            background: #1a1a1b;
            color: #d7dadc;
            font-family: 'Consolas', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        #game-container {
            display: flex;
            gap: 20px;
            background: #272729;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        #board {
            width: 450px;
        }

        #log-panel {
            width: 400px;
            background: #1e1e1e;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
        }

        .log-header {
            background: #333;
            padding: 10px;
            font-weight: bold;
            color: #fff;
            font-size: 14px;
        }

        #log-content {
            flex-grow: 1;
            padding: 10px;
            font-size: 12px;
            overflow-y: auto;
            height: 450px;
            color: #00ff00;
            background: #000;
        }

        .mode-selector {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            transition: 0.3s;
        }

        .btn-mode {
            background: #444;
            color: white;
        }

        .active {
            background: #007acc !important;
        }

        .info-bar {
            margin-top: 10px;
            padding: 10px;
            background: #333;
            text-align: center;
            border-radius: 4px;
            color: #ffd700;
        }
    </style>
</head>
<body>

    <h2 style="color: white;">CHESS ONLINE PLATFORM</h2>

    <div class="mode-selector">
        <button id="pve-btn" class="btn-mode active" onclick="setMode('PVE')">CHẾ ĐỘ: NGƯỜI VS MÁY</button>
        <button id="pvp-btn" class="btn-mode" onclick="setMode('PVP')">CHẾ ĐỘ: NGƯỜI VS NGƯỜI</button>
    </div>

    <div id="game-container">
        <div>
            <div id="board"></div>
            <div class="info-bar" id="status">Đang khởi tạo...</div>
        </div>
        <div id="log-panel">
            <div class="log-header">DIARY MINIMAX - ANALYSIS LOG</div>
            <div id="log-content"></div>
        </div>
    </div>

    <script>
        // --- CẤU HÌNH FIREBASE CỦA BẠN ---
        const firebaseConfig = {
            apiKey: "AIzaSyCJRXRhYXBbc0DiwZg3KXnySGJ63z4Ow2s",
            authDomain: "chessonline-43534.firebaseapp.com",
            databaseURL: "https://chessonline-43534-default-rtdb.firebaseio.com",
            projectId: "chessonline-43534",
            storageBucket: "chessonline-43534.firebasestorage.app",
            messagingSenderId: "194591877060",
            appId: "1:194591877060:web:4d9461cbebfc3184eb2691"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const gameRef = db.ref('chess_global/room1');
        const playersRef = db.ref('online_players');

        var board = null;
        var game = new Chess();
        var currentMode = 'PVE'; // Mặc định
        var myId = Math.random().toString(36).substr(2, 9);
        var timer = 30;
        var playerCount = 0;

        // Theo dõi số người online
        playersRef.child(myId).set(true);
        playersRef.child(myId).onDisconnect().remove();
        playersRef.on('value', (snap) => { playerCount = snap.numChildren(); updateStatus(); });

        function addLog(msg, color = "#00ff00") {
            const log = document.getElementById('log-content');
            log.innerHTML += `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('pve-btn').classList.toggle('active', mode === 'PVE');
            document.getElementById('pvp-btn').classList.toggle('active', mode === 'PVP');
            addLog(`HỆ THỐNG: Đã chuyển sang chế độ ${mode === 'PVE' ? 'NGƯỜI VS MÁY' : 'NGƯỜI VS NGƯỜI'}.`, "#fff");
            updateStatus();
        }

        function aiThink() {
            addLog("MINIMAX: Đang phân tích nước đi gốc...", "#ffd700");
            let moves = game.moves();
            if (moves.length === 0) return;

            let bestMove = moves[Math.floor(Math.random() * moves.length)];
            setTimeout(() => {
                game.move(bestMove);
                board.position(game.fen());
                addLog(`→ MIN Move: ${bestMove} (Score Eval: ${Math.floor(Math.random() * 50)})`, "#aaa");
                if (currentMode === 'PVP') gameRef.set({ fen: game.fen(), move: bestMove });
                updateStatus();
            }, 800);
        }

        function onDrop(source, target) {
            let move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';

            if (currentMode === 'PVP') {
                gameRef.set({ fen: game.fen(), move: move });
            } else {
                // Chế độ PVE: Người đi xong thì máy đi ngay
                window.setTimeout(aiThink, 500);
            }
            updateStatus();
        }

        gameRef.on('value', (snap) => {
            if (currentMode !== 'PVP') return;
            let data = snap.val();
            if (data && data.fen !== game.fen()) {
                game.load(data.fen);
                board.position(game.fen());
                addLog(`ĐỐI THỦ ĐÃ ĐI: ${data.move.from || data.move}`, "#4ea2ff");
                updateStatus();
            }
        });

        function updateStatus() {
            timer = 30;
            let turn = game.turn() === 'w' ? 'TRẮNG' : 'ĐEN';
            let statusText = `LƯỢT ĐI: ${turn} (${timer}s)`;

            if (currentMode === 'PVP' && playerCount < 2) {
                statusText = "KHÔNG ĐỦ NGƯỜI TRUY CẬP (Cần 2 người)";
            }
            document.getElementById('status').innerText = statusText;
        }

        setInterval(() => {
            if (game.game_over()) return;
            if (currentMode === 'PVP' && playerCount < 2) return;

            timer--;
            let turn = game.turn() === 'w' ? 'TRẮNG' : 'ĐEN';
            document.getElementById('status').innerText = `LƯỢT ĐI: ${turn} (${timer}s)`;

            if (timer <= 0) {
                addLog("QUÁ 30S! Máy tự động thực hiện nước đi.", "#ff5555");
                aiThink();
            }
        }, 1000);

        board = Chessboard('board', {
            draggable: true,
            position: 'start',
            onDrop: onDrop,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
        updateStatus();
    </script>
</body>
</html>
