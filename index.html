<!DOCTYPE html>
<html>
<head>
    <title>Chess Pro - King Capture Mode</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body {
            background: #1a1a1a;
            color: #eee;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
        }

        #game-container {
            display: flex;
            gap: 20px;
            background: #2a2a2a;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        #board {
            width: 450px;
        }

        .info-bar {
            margin: 15px 0;
            padding: 12px;
            background: #333;
            border-radius: 8px;
            text-align: center;
            color: #ffd700;
            font-weight: bold;
        }

        /* Hiệu ứng ô cờ */
        .highlight-selected {
            background: rgba(255, 255, 0, 0.6) !important;
        }

        .highlight-hint {
            background: rgba(0, 255, 100, 0.4) !important;
        }

        .highlight-check {
            background: rgba(255, 0, 0, 0.8) !important;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 12px 25px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            transition: 0.3s;
        }

        .btn-mode {
            background: #444;
            color: white;
            border: 2px solid transparent;
        }

            .btn-mode.active {
                background: #007acc;
                border-color: #fff;
            }

        .btn-exit {
            background: #e74c3c;
            color: white;
            width: 100%;
            margin-top: 10px;
        }

        /* Modal */
        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
        }

        #custom-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            color: #333;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            z-index: 101;
            border: 5px solid #ffd700;
        }
    </style>
</head>
<body>

    <div id="modal-overlay"></div>
    <div id="custom-modal">
        <h1 id="modal-title" style="color:#c0392b">CHIẾN THẮNG!</h1>
        <p id="modal-msg" style="font-size: 1.3em; margin: 20px 0;"></p>
        <button onclick="location.reload()" style="background:#27ae60; color:white; padding:15px 40px; font-size:1.1em;">CHỌN LẠI CHẾ ĐỘ CHƠI</button>
    </div>

    <h2 id="header-title">CHESS ONLINE: KING HUNTER</h2>

    <div class="controls" id="mode-selection">
        <button id="pve-btn" class="btn-mode active" onclick="setMode('PVE')">NGƯỜI VS MÁY</button>
        <button id="pvp-btn" class="btn-mode" onclick="setMode('PVP')">NGƯỜI VS NGƯỜI</button>
    </div>

    <div id="game-container">
        <div>
            <div id="board"></div>
            <div class="info-bar" id="status">Vui lòng chọn chế độ...</div>
            <button class="btn-exit" onclick="forceExit()">THOÁT & CHỌN LẠI</button>
        </div>
        <div style="width: 320px; background:#000; color:#0f0; padding:15px; font-family:monospace; height:450px; overflow-y:auto; border-radius:8px;" id="logs">
            <div>[HỆ THỐNG] Khởi động hoàn tất.</div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCJRXRhYXBbc0DiwZg3KXnySGJ63z4Ow2s",
            authDomain: "chessonline-43534.firebaseapp.com",
            databaseURL: "https://chessonline-43534-default-rtdb.firebaseio.com",
            projectId: "chessonline-43534"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const gameRef = db.ref('chess_global/room1');

        let board = null;
        let game = new Chess();
        let currentMode = 'PVE';
        let selectedSquare = null;
        let gameOver = false;

        function addLog(m) {
            $('#logs').append(`<div>> ${m}</div>`);
            $('#logs').scrollTop($('#logs')[0].scrollHeight);
        }

        // --- CƠ CHẾ CLICK-TO-MOVE ---
        function onSquareClick(square) {
            if (gameOver) return;

            if (selectedSquare) {
                let move = game.move({ from: selectedSquare, to: square, promotion: 'q' });

                if (move === null) {
                    selectedSquare = square;
                    highlightAvailableMoves(square);
                } else {
                    selectedSquare = null;
                    $('.highlight-hint, .highlight-selected').removeClass('highlight-hint highlight-selected');
                    board.position(game.fen());
                    processMove(move);
                }
            } else {
                selectedSquare = square;
                highlightAvailableMoves(square);
            }
        }

        function highlightAvailableMoves(square) {
            $('.highlight-hint, .highlight-selected').removeClass('highlight-hint highlight-selected');
            let moves = game.moves({ square: square, verbose: true });
            if (moves.length > 0) {
                $(`#board .square-${square}`).addClass('highlight-selected');
                moves.forEach(m => $(`#board .square-${m.to}`).addClass('highlight-hint'));
            }
        }

        function processMove(move) {
            updateUI();

            // KIỂM TRA MẤT TƯỚNG (KING CAPTURED)
            // Trong cờ vua chuẩn (chess.js), khi chiếu bí là game kết thúc.
            // Ta giả lập việc "mất tướng" bằng cách kiểm tra checkmate.
            if (game.in_checkmate()) {
                gameOver = true;
                let winnerText = "";
                if (currentMode === 'PVE') {
                    winnerText = game.turn() === 'w' ? "MÁY ĐÃ ĂN TƯỚNG CỦA BẠN!" : "BẠN ĐÃ ĂN TƯỚNG CỦA MÁY!";
                } else {
                    winnerText = game.turn() === 'w' ? "QUÂN ĐEN ĐÃ ĂN TƯỚNG!" : "QUÂN TRẮNG ĐÃ ĂN TƯỚNG!";
                }
                setTimeout(() => {
                    $('#modal-msg').text(winnerText);
                    $('#modal-overlay, #custom-modal').fadeIn();
                }, 500);
                return;
            }

            if (currentMode === 'PVP') {
                gameRef.set({ fen: game.fen(), move: move });
            } else if (game.turn() === 'b') {
                setTimeout(aiMove, 600);
            }
        }

        function aiMove() {
            let moves = game.moves();
            if (moves.length === 0) return;
            let move = moves[Math.floor(Math.random() * moves.length)];
            game.move(move);
            board.position(game.fen());
            processMove(move);
        }

        function updateUI() {
            let turn = game.turn() === 'w' ? "TRẮNG" : "ĐEN";
            $('#status').text(`LƯỢT ĐI: ${turn}`);

            // CHỈ HIỆN ĐỎ KHI NGƯỜI CHƠI BỊ CHIẾU
            $('.highlight-check').removeClass('highlight-check');
            if (game.in_check()) {
                // Nếu là lượt của người (Trắng trong PVE) và đang bị chiếu
                if (currentMode === 'PVE' && game.turn() === 'w') {
                    let kingPos = findKing('w');
                    $(`#board .square-${kingPos}`).addClass('highlight-check');
                    addLog("CẢNH BÁO: Tướng của bạn đang bị chiếu!");
                } else if (currentMode === 'PVP') {
                    let kingPos = findKing(game.turn());
                    $(`#board .square-${kingPos}`).addClass('highlight-check');
                }
            }
        }

        function findKing(color) {
            let b = game.board();
            for (let i = 0; i < 8; i++) {
                for (let j = 0; j < 8; j++) {
                    if (b[i][j] && b[i][j].type === 'k' && b[i][j].color === color) {
                        return String.fromCharCode(97 + j) + (8 - i);
                    }
                }
            }
        }

        function setMode(m) {
            currentMode = m;
            $('.btn-mode').removeClass('active');
            $(`#${m.toLowerCase()}-btn`).addClass('active');
            addLog(`ĐÃ CHUYỂN: ${m}`);
            resetBoardState();
        }

        function resetBoardState() {
            game.reset();
            board.position('start');
            gameOver = false;
            updateUI();
        }

        function forceExit() {
            gameRef.remove(); // Xóa dữ liệu phòng nếu có
            location.reload(); // Bắt buộc chọn lại từ đầu
        }

        // Firebase sync
        gameRef.on('value', snap => {
            if (currentMode !== 'PVP') return;
            let data = snap.val();
            if (data && data.fen !== game.fen()) {
                game.load(data.fen);
                board.position(game.fen());
                updateUI();
            }
        });

        board = Chessboard('board', {
            position: 'start',
            draggable: false, // Click to move only
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });

        $('#board').on('click', '.square-55d6', function () {
            onSquareClick($(this).data('square'));
        });

        updateUI();
    </script>
</body>
</html>
