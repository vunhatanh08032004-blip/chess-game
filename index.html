<!DOCTYPE html>
<html>
<head>
    <title>Chess Master - Ultimate Fixed</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <style>
        body { background: #1a1a1a; color: white; font-family: 'Segoe UI', Arial; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        #main-layout { display: flex; gap: 20px; background: #262626; padding: 20px; border-radius: 4px; }
        
        #game-outer { position: relative; width: 450px; height: 450px; border: 2px solid #555; }
        #board { width: 100%; height: 100%; }
        
        /* Overlay bắt click */
        #click-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr);
            z-index: 10; cursor: pointer;
        }
        .click-cell { width: 100%; height: 100%; box-sizing: border-box; border: 3px solid transparent; }

        /* Hiệu ứng Viền */
        .border-selected { border: 4px solid #ffff00 !important; z-index: 11; } 
        .border-hint { border: 4px solid #00ff00 !important; z-index: 11; }     
        .border-check { border: 4px solid #ff0000 !important; z-index: 12; animation: blink 0.5s step-end infinite; } 
        @keyframes blink { 50% { border-color: transparent; } }

        /* Nhật ký bên phải */
        #logs-container { width: 250px; display: flex; flex-direction: column; }
        #logs { flex-grow: 1; background: #000; color: #0f0; padding: 10px; font-family: monospace; height: 400px; overflow-y: auto; border: 1px solid #444; font-size: 12px; }

        .info-bar { margin: 10px 0; padding: 10px; background: #333; text-align: center; color: #00ffcc; font-weight: bold; border-radius: 4px; }
        
        /* MODAL CHUẨN CRITICAL ERROR */
        #modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; }
        .critical-error-box { 
            display: none; position: fixed; top:50%; left:50%; transform:translate(-50%, -50%); 
            width: 380px; background: #f0f0f0; border: 2px solid #0055ea; z-index: 1001; color: #000;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.5);
        }
        .ce-header { background: linear-gradient(to right, #0055ea, #0a84ff); color: white; padding: 5px 10px; font-size: 13px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .ce-body { padding: 25px 20px; display: flex; align-items: center; gap: 15px; background: white; }
        .ce-icon { width: 35px; height: 35px; background: #fbc02d; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); display: flex; justify-content: center; align-items: flex-end; font-weight: bold; font-size: 18px; padding-bottom: 2px; }
        .ce-footer { padding: 10px; text-align: center; background: #f0f0f0; border-top: 1px solid #ccc; }
        .ce-btn { min-width: 80px; padding: 5px 15px; background: #e1e1e1; border: 1px solid #777; cursor: pointer; margin: 0 5px; box-shadow: inset -1px -1px 1px #888; }
        .ce-btn:active { box-shadow: inset 1px 1px 1px #888; }

        .controls { margin-bottom: 15px; }
        .mode-btn { padding: 10px 20px; background: #444; color: #ccc; border: none; cursor: pointer; margin-right: 5px; font-weight: bold; }
        .mode-btn.active { background: #007acc; color: white; }
    </style>
</head>
<body>

    <div id="modal-overlay"></div>
    <div id="custom-modal" class="critical-error-box">
        <div class="ce-header">
            <span id="ce-title">Error</span>
            <span style="cursor:pointer" onclick="closeModal()">×</span>
        </div>
        <div class="ce-body">
            <div class="ce-icon">!</div>
            <div id="ce-msg">Critical error</div>
        </div>
        <div class="ce-footer" id="ce-buttons">
            </div>
    </div>

    <div class="controls">
        <button id="pve-btn" class="mode-btn active" onclick="requestChangeMode('PVE')">NGƯỜI VS MÁY</button>
        <button id="pvp-btn" class="mode-btn" onclick="requestChangeMode('PVP')">NGƯỜI VS NGƯỜI</button>
    </div>

    <div id="main-layout">
        <div>
            <div id="game-outer">
                <div id="board"></div>
                <div id="click-overlay"></div>
            </div>
            <div class="info-bar" id="status">LƯỢT ĐI: TRẮNG</div>
        </div>

        <div id="logs-container">
            <div id="logs">> Sẵn sàng...</div>
            <button style="background:#e74c3c; color:white; padding:10px; border:none; cursor:pointer; margin-top:10px;" onclick="confirmExit()">THOÁT TRẬN</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

    <script>
        var board = null;
        var game = new Chess();
        var selectedSquare = null;
        var currentMode = 'PVE';

        function initOverlay() {
            const overlay = $('#click-overlay');
            overlay.empty();
            const columns = ['a','b','c','d','e','f','g','h'];
            for(let i=8; i>=1; i--) {
                columns.forEach(col => {
                    let sq = col + i;
                    overlay.append(`<div class="click-cell" id="overlay-${sq}" data-sq="${sq}"></div>`);
                });
            }
        }

        $(document).on('click', '.click-cell', function() {
            const square = $(this).data('sq');
            if (selectedSquare) {
                let move = game.move({ from: selectedSquare, to: square, promotion: 'q' });
                if (move) {
                    addLog(`Trắng: ${move.from} đi ${move.to}`);
                    selectedSquare = null;
                    clearBorders();
                    board.position(game.fen());
                    updateGame();
                    if (currentMode === 'PVE' && !game.game_over()) setTimeout(makeAiMove, 600);
                } else {
                    let piece = game.get(square);
                    if (piece && piece.color === game.turn()) {
                        selectedSquare = square;
                        drawBorders(square);
                    } else {
                        selectedSquare = null;
                        clearBorders();
                    }
                }
            } else {
                let piece = game.get(square);
                if (piece && piece.color === game.turn()) {
                    selectedSquare = square;
                    drawBorders(square);
                }
            }
        });

        function makeAiMove() {
            const moves = game.moves();
            if (moves.length === 0) return;
            let move = game.move(moves[Math.floor(Math.random() * moves.length)]);
            addLog(`Đen (Máy): ${move.from} đi ${move.to}`);
            board.position(game.fen());
            updateGame();
        }

        function drawBorders(square) {
            clearBorders();
            $(`#overlay-${square}`).addClass('border-selected');
            game.moves({ square: square, verbose: true }).forEach(m => {
                $(`#overlay-${m.to}`).addClass('border-hint');
            });
        }

        function clearBorders() { $('.click-cell').removeClass('border-selected border-hint'); }

        function updateGame() {
            $('#status').text("LƯỢT ĐI: " + (game.turn() === 'w' ? "TRẮNG" : "ĐEN"));
            $('.click-cell').removeClass('border-check');
            if (game.in_check()) {
                let kingPos = "";
                game.board().forEach((row, r) => row.forEach((p, c) => {
                    if(p && p.type === 'k' && p.color === game.turn()) kingPos = String.fromCharCode(97+c)+(8-r);
                }));
                $(`#overlay-${kingPos}`).addClass('border-check');
            }
            if (game.in_checkmate()) {
                showCriticalError("Game Over", (game.turn() === 'w' ? "QUÂN ĐEN" : "QUÂN TRẮNG") + " ĐÃ ĂN TƯỚNG!", [{text: "OK", click: "location.reload()"}]);
            }
        }

        // MODAL LOGIC
        function showCriticalError(title, msg, buttons) {
            $('#ce-title').text(title);
            $('#ce-msg').text(msg);
            let btnHtml = buttons.map(b => `<button class="ce-btn" onclick="${b.click}">${b.text}</button>`).join('');
            $('#ce-buttons').html(btnHtml);
            $('#modal-overlay, #custom-modal').show();
        }

        function closeModal() { $('#modal-overlay, #custom-modal').hide(); }

        // CHUYỂN CHẾ ĐỘ
        function requestChangeMode(newMode) {
            if (newMode === currentMode) return;
            if (game.history().length > 0) {
                showCriticalError("Xác nhận", "Bạn đang chơi dở trận, có chắc chắn muốn chuyển qua chế độ khác không?", [
                    {text: "Yes", click: `executeChange('${newMode}')`},
                    {text: "No", click: "closeModal()"}
                ]);
            } else {
                executeChange(newMode);
            }
        }

        function executeChange(m) {
            closeModal();
            if (m === 'PVP') {
                showCriticalError("Matchmaking", "Không đủ người chơi, bạn có muốn chuyển qua chế độ người với máy?", [
                    {text: "Yes", click: "resetGame('PVE')"},
                    {text: "No", click: "closeModal()"}
                ]);
            } else {
                resetGame('PVE');
            }
        }

        function resetGame(m) {
            closeModal();
            currentMode = m;
            game.reset();
            board.start();
            clearBorders();
            updateGame();
            $('.mode-btn').removeClass('active');
            $(`#${m.toLowerCase()}-btn`).addClass('active');
            $('#logs').html("> Đã reset bàn cờ. Chế độ: " + m);
        }

        function confirmExit() {
            showCriticalError("Thoát", "Bạn có chắc chắn muốn thoát dở trận?", [
                {text: "Yes", click: "location.reload()"},
                {text: "No", click: "closeModal()"}
            ]);
        }

        function addLog(msg) {
            $('#logs').append(`<div>> ${msg}</div>`);
            $('#logs').scrollTop($('#logs')[0].scrollHeight);
        }

        board = Chessboard('board', { position: 'start', draggable: false, pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' });
        initOverlay();
        updateGame();
    </script>
</body>
</html>
