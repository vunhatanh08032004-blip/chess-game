<!DOCTYPE html>
<html>
<head>
    <title>Chess Master - Full Alerts</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #game-container { display: flex; gap: 20px; background: #262626; padding: 20px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #board { width: 450px; }
        .highlight-selected { background: rgba(255, 255, 0, 0.5) !important; }
        .highlight-hint { background: rgba(0, 255, 0, 0.3) !important; }
        .highlight-check { background: rgba(255, 0, 0, 0.7) !important; }
        .info-bar { margin: 10px 0; padding: 10px; background: #333; width: 100%; text-align: center; color: #00ffcc; border-radius: 5px; }
        .controls { margin-bottom: 15px; display: flex; gap: 10px; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        .btn-mode { background: #444; color: #ccc; }
        .btn-mode.active { background: #007acc; color: white; }
        .btn-exit { background: #e74c3c; color: white; width: 100%; margin-top: 10px; }
        #modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100; }
        #custom-modal { display: none; position: fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; color:black; padding:30px; border-radius:10px; text-align:center; z-index:101; border: 4px solid #27ae60; }
    </style>
</head>
<body>

    <div id="modal-overlay"></div>
    <div id="custom-modal">
        <h1 id="modal-title">CHIẾN THẮNG!</h1>
        <p id="modal-msg"></p>
        <button onclick="location.reload()" style="background:#27ae60; color:white; padding:10px 30px;">CHỌN LẠI CHẾ ĐỘ</button>
    </div>

    <div class="controls">
        <button id="pve-btn" class="btn-mode active" onclick="setGameMode('PVE')">NGƯỜI VS MÁY</button>
        <button id="pvp-btn" class="btn-mode" onclick="setGameMode('PVP')">NGƯỜI VS NGƯỜI</button>
    </div>

    <div id="game-container">
        <div>
            <div id="board"></div>
            <div class="info-bar" id="status">LƯỢT ĐI: TRẮNG</div>
            <button class="btn-exit" onclick="confirmExit()">THOÁT & RESET</button>
        </div>
        <div id="logs" style="width:250px; background:black; color:#0f0; padding:10px; font-family:monospace; height:450px; overflow-y:auto; font-size:12px;">
            > Chào mừng bạn!
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Cấu hình Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCJRXRhYXBbc0DiwZg3KXnySGJ63z4Ow2s",
            databaseURL: "https://chessonline-43534-default-rtdb.firebaseio.com",
            projectId: "chessonline-43534"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const gameRef = db.ref('chess_global/room1');
        const playersRef = db.ref('online_players');

        var board = null;
        var game = new Chess();
        var selectedSquare = null;
        var currentMode = 'PVE';
        var myId = Math.random().toString(36).substr(2, 9);

        // 1. Thông báo khi chọn chế độ
        function setGameMode(m) {
            let modeName = m === 'PVE' ? "Người vs Máy" : "Người vs Người";
            alert("Bạn đã chọn chế độ: " + modeName);
            currentMode = m;
            location.reload(); 
        }

        // 2. Thông báo xác nhận thoát (Yes/No)
        function confirmExit() {
            let text = "Bạn có chắc chắn muốn thoát không?\nKết quả trận đấu sẽ bị hủy.";
            if (confirm(text) == true) {
                playersRef.child(myId).remove();
                gameRef.remove();
                location.reload();
            } else {
                // Người dùng chọn No, không làm gì cả
            }
        }

        // Theo dõi số lượng người chơi (Thông báo đủ người)
        playersRef.child(myId).set(true);
        playersRef.child(myId).onDisconnect().remove();
        playersRef.on('value', snap => {
            if (currentMode === 'PVP' && snap.numChildren() === 2) {
                alert("Đã đủ 2 người chơi! Trận đấu bắt đầu.");
                addLog("HỆ THỐNG: Đã kết nối đối thủ.");
            }
        });

        function onSquareClick(square) {
            if (selectedSquare) {
                var move = game.move({ from: selectedSquare, to: square, promotion: 'q' });
                if (move === null) {
                    var piece = game.get(square);
                    if (piece && piece.color === game.turn()) {
                        selectedSquare = square;
                        highlightMoves(square);
                    } else {
                        selectedSquare = null;
                        clearHighlights();
                    }
                } else {
                    selectedSquare = null;
                    clearHighlights();
                    board.position(game.fen());
                    checkStatus();
                    if (currentMode === 'PVE' && !game.game_over()) setTimeout(makeAiMove, 500);
                    if (currentMode === 'PVP') gameRef.set({ fen: game.fen() });
                }
            } else {
                var piece = game.get(square);
                if (piece && piece.color === game.turn()) {
                    selectedSquare = square;
                    highlightMoves(square);
                }
            }
        }

        function highlightMoves(square) {
            clearHighlights();
            $(`#board .square-${square}`).addClass('highlight-selected');
            game.moves({ square: square, verbose: true }).forEach(m => {
                $(`#board .square-${m.to}`).addClass('highlight-hint');
            });
        }

        function clearHighlights() {
            $('.square-55d6').removeClass('highlight-selected highlight-hint highlight-check');
        }

        function checkStatus() {
            var turn = game.turn() === 'w' ? "TRẮNG" : "ĐEN";
            $('#status').text("LƯỢT ĐI: " + turn);
            if (game.in_check()) {
                var kingPos = findKing(game.turn());
                $(`#board .square-${kingPos}`).addClass('highlight-check');
            }
            if (game.in_checkmate()) {
                var winner = game.turn() === 'w' ? "QUÂN ĐEN" : "QUÂN TRẮNG";
                $('#modal-msg').text(winner + " ĐÃ ĂN ĐƯỢC TƯỚNG!");
                $('#modal-overlay, #custom-modal').show();
            }
        }

        function makeAiMove() {
            var moves = game.moves();
            if (moves.length === 0) return;
            game.move(moves[Math.floor(Math.random() * moves.length)]);
            board.position(game.fen());
            checkStatus();
        }

        function findKing(color) {
            var b = game.board();
            for (var i=0; i<8; i++)
                for (var j=0; j<8; j++)
                    if (b[i][j] && b[i][j].type === 'k' && b[i][j].color === color)
                        return String.fromCharCode(97 + j) + (8 - i);
        }

        function addLog(msg) {
            $('#logs').append(`<div>> ${msg}</div>`);
            $('#logs').scrollTop($('#logs')[0].scrollHeight);
        }

        board = Chessboard('board', {
            position: 'start',
            draggable: false,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });

        $(document).on('click', '.square-55d6', function() {
            onSquareClick($(this).attr('data-square'));
        });

        gameRef.on('value', snap => {
            if (currentMode === 'PVP' && snap.val()) {
                game.load(snap.val().fen);
                board.position(game.fen());
                checkStatus();
            }
        });
    </script>
</body>
</html>
