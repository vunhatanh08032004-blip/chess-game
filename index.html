<!DOCTYPE html>
<html>
<head>
    <title>Chess Master - Circular Timer & Detailed Logs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <style>
        body { background: #1a1a1a; color: white; font-family: 'Segoe UI', Arial; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #main-container { display: flex; align-items: center; gap: 30px; background: #262626; padding: 30px; border-radius: 8px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        
        /* Đồng hồ hình tròn bên trái */
        #timer-container { position: relative; width: 120px; height: 120px; display: flex; justify-content: center; align-items: center; }
        .circle-bg { fill: none; stroke: #444; stroke-width: 8; }
        .circle-progress { fill: none; stroke: #00ffcc; stroke-width: 8; stroke-linecap: round; stroke-dasharray: 314; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear, stroke 0.3s; transform: rotate(-90deg); transform-origin: 50% 50%; }
        #timer-text { position: absolute; font-size: 28px; font-weight: bold; color: #00ffcc; }

        /* Bàn cờ */
        #game-outer { position: relative; width: 500px; height: 500px; border: 4px solid #444; }
        #board { width: 100%; height: 100%; }
        #click-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr); z-index: 10; cursor: pointer; }
        .click-cell { width: 100%; height: 100%; box-sizing: border-box; }
        .border-selected { border: 4px solid #ffff00 !important; z-index: 11; background: rgba(255,255,0,0.2); } 
        .border-hint { border: 4px solid #00ff00 !important; z-index: 11; }     
        .border-check { border: 4px solid #ff0000 !important; z-index: 12; animation: blink 0.5s step-end infinite; } 
        @keyframes blink { 50% { border-color: transparent; } }

        /* Nhật ký bên phải */
        #side-panel { width: 300px; height: 500px; display: flex; flex-direction: column; gap: 10px; }
        #logs { flex-grow: 1; background: #000; color: #0f0; padding: 12px; font-family: 'Consolas', monospace; overflow-y: auto; border: 1px solid #444; font-size: 11px; line-height: 1.6; border-radius: 4px; }
        .log-time { color: #888; margin-right: 5px; }
        .log-action { color: #fff; }
        .log-sys { color: #007acc; font-weight: bold; }
        .log-warn { color: #ffcc00; }
        .log-danger { color: #ff3333; font-weight: bold; }
        .log-win { color: #ff00ff; font-weight: bold; border-left: 3px solid #ff00ff; padding-left: 5px; }

        /* Modal */
        #modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; }
        .critical-error-box { display: none; position: fixed; top:50%; left:50%; transform:translate(-50%, -50%); width: 350px; background: #f0f0f0; border: 2px solid #0055ea; z-index: 1001; color: #000; }
        .ce-header { background: #0055ea; color: white; padding: 5px 10px; font-size: 13px; font-weight: bold; display: flex; justify-content: space-between; }
        .ce-body { padding: 20px; display: flex; align-items: center; gap: 15px; background: white; }
        .ce-footer { padding: 10px; text-align: right; background: #f0f0f0; border-top: 1px solid #ccc; }
        .ce-btn { padding: 5px 15px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="modal-overlay"></div>
    <div id="custom-modal" class="critical-error-box">
        <div class="ce-header"><span>Hệ thống Chess Master</span><span style="cursor:pointer" onclick="closeModal()">×</span></div>
        <div class="ce-body"><div id="ce-msg">Thông báo</div></div>
        <div class="ce-footer" id="ce-buttons"></div>
    </div>

    <div id="main-container">
        <div id="timer-container">
            <svg width="120" height="120">
                <circle class="circle-bg" cx="60" cy="60" r="50"></circle>
                <circle id="progress-bar" class="circle-progress" cx="60" cy="60" r="50"></circle>
            </svg>
            <div id="timer-text">30</div>
        </div>

        <div id="game-outer">
            <div id="board"></div>
            <div id="click-overlay"></div>
        </div>

        <div id="side-panel">
            <div style="text-align: center; color: #00ffcc; font-weight: bold;">NHẬT KÝ HOẠT ĐỘNG</div>
            <div id="logs"></div>
            <button style="background:#444; color:white; padding:8px; border:none; cursor:pointer;" onclick="location.reload()">LÀM MỚI GAME</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

    <script>
        var board = null, game = new Chess(), selectedSquare = null;
        var timerMax = 30, timerValue = 30, timerInterval = null;

        function addLog(msg, type = '') {
            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
            $('#logs').append(`<div><span class="log-time">[${timeStr}]</span> <span class="${type}">${msg}</span></div>`);
            $('#logs').scrollTop($('#logs')[0].scrollHeight);
        }

        function updateTimerCircle() {
            const offset = 314 - (timerValue / timerMax) * 314;
            $('#progress-bar').css('stroke-dashoffset', offset);
            $('#timer-text').text(timerValue);
            
            // Đổi màu khi sắp hết giờ
            if (timerValue <= 5) {
                $('#progress-bar, #timer-text').css('stroke', '#ff3333').css('color', '#ff3333');
            } else {
                $('#progress-bar, #timer-text').css('stroke', '#00ffcc').css('color', '#00ffcc');
            }
        }

        function startTimer() {
            stopTimer();
            timerMax = (game.turn() === 'w') ? 30 : 10;
            timerValue = timerMax;
            updateTimerCircle();
            
            timerInterval = setInterval(() => {
                timerValue--;
                updateTimerCircle();
                if (timerValue <= 0) {
                    stopTimer();
                    addLog("HỆ THỐNG: Quá 30 giây! Máy tự động đi thay người chơi.", "log-danger");
                    makeAiMove();
                }
            }, 1000);
        }

        function stopTimer() { clearInterval(timerInterval); }

        function makeAiMove() {
            let moves = game.moves();
            if (moves.length === 0) return;
            let move = moves[Math.floor(Math.random() * moves.length)];
            game.move(move);
            board.position(game.fen());
            addLog(`MÁY: Đã thực hiện nước đi ${move}`, "log-action");
            updateGameStatus();
        }

        function initOverlay() {
            const overlay = $('#click-overlay'); overlay.empty();
            for(let i=8; i>=1; i--) ['a','b','c','d','e','f','g','h'].forEach(c => {
                overlay.append(`<div class="click-cell" id="overlay-${c+i}" data-sq="${c+i}"></div>`);
            });
        }

        $(document).on('click', '.click-cell', function() {
            const sq = $(this).data('sq');
            const piece = game.get(sq);

            if (selectedSquare) {
                if (sq === selectedSquare) {
                    addLog(`BẠN: Hủy chọn ô ${sq}`, "log-sys");
                    selectedSquare = null; clearBorders(); return;
                }
                
                let move = game.move({ from: selectedSquare, to: sq, promotion: 'q' });
                if (move) {
                    addLog(`BẠN: Di chuyển ${move.piece.toUpperCase()} từ ${move.from} đến ${move.to}`, "log-action");
                    board.position(game.fen());
                    selectedSquare = null; clearBorders();
                    updateGameStatus();
                    if (!game.game_over()) setTimeout(makeAiMove, 600);
                } else {
                    if (piece && piece.color === game.turn()) {
                        selectPiece(sq);
                    } else {
                        addLog(`LỖI: Nước đi đến ${sq} không hợp lệ!`, "log-warn");
                    }
                }
            } else {
                if (piece) {
                    if (piece.color === game.turn()) selectPiece(sq);
                    else addLog(`LỖI: Không thể chọn quân đối phương!`, "log-warn");
                } else {
                    addLog(`HỆ THỐNG: Ô ${sq} trống.`, "log-sys");
                }
            }
        });

        function selectPiece(sq) {
            selectedSquare = sq;
            let p = game.get(sq);
            addLog(`BẠN: Đang chọn ${p.type.toUpperCase()} tại ${sq}`, "log-sys");
            drawBorders(sq);
        }

        function updateGameStatus() {
            if (game.in_check()) {
                addLog(`CẢNH BÁO: Quân ${game.turn()==='w'?'TRẮNG':'ĐEN'} đang bị chiếu!`, "log-danger");
                let k = ""; game.board().forEach((r,ri)=>r.forEach((p,ci)=>{if(p&&p.type==='k'&&p.color===game.turn()) k=String.fromCharCode(97+ci)+(8-ri)}));
                $(`#overlay-${k}`).addClass('border-check');
            }

            if (game.moves().length === 0) {
                stopTimer();
                let winner = (game.turn() === 'w') ? "QUÂN ĐEN" : "QUÂN TRẮNG";
                addLog(`TRẬN ĐẤU KẾT THÚC: ${winner} THẮNG CUỘC!`, "log-win");
                showCriticalError("Kết thúc", winner + " CHIẾN THẮNG!", [{text: "Chơi lại", click: "location.reload()"}]);
            } else {
                startTimer();
            }
        }

        function drawBorders(s) { clearBorders(); $(`#overlay-${s}`).addClass('border-selected'); game.moves({square:s, verbose:true}).forEach(m=>$(`#overlay-${m.to}`).addClass('border-hint')) }
        function clearBorders() { $('.click-cell').removeClass('border-selected border-hint border-check') }
        function showCriticalError(t,m,b) { $('#ce-msg').text(m); $('#ce-buttons').html(b.map(x=>`<button class="ce-btn" onclick="${x.click}">${x.text}</button>`).join('')); $('#modal-overlay, #custom-modal').show(); }
        function closeModal() { $('#modal-overlay, #custom-modal').hide(); }

        board = Chessboard('board', { position: 'start', draggable: false, pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' });
        initOverlay();
        addLog("HỆ THỐNG: Chào mừng bạn đến với Chess Master!", "log-sys");
        addLog("HỆ THỐNG: Bắt đầu lượt của quân TRẮNG (30s).", "log-sys");
        startTimer();
    </script>
</body>
</html>
