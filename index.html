<!DOCTYPE html>
<html>
<head>
    <title>Chess Master - Pro Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <style>
        body { background: #1a1a1a; color: white; font-family: 'Segoe UI', Arial; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #main-layout { display: flex; gap: 20px; background: #262626; padding: 20px; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); opacity: 0.3; pointer-events: none; transition: 0.3s; }
        #game-outer { position: relative; width: 450px; height: 450px; border: 2px solid #555; }
        #board { width: 100%; height: 100%; }
        #click-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr); z-index: 10; cursor: pointer; }
        .click-cell { width: 100%; height: 100%; box-sizing: border-box; border: 3px solid transparent; }
        .border-selected { border: 4px solid #ffff00 !important; z-index: 11; } 
        .border-hint { border: 4px solid #00ff00 !important; z-index: 11; }     
        #logs-container { width: 250px; display: flex; flex-direction: column; }
        #logs { flex-grow: 1; background: #000; color: #0f0; padding: 10px; font-family: monospace; height: 400px; overflow-y: auto; border: 1px solid #444; font-size: 12px; }
        .info-bar { margin: 10px 0; padding: 10px; background: #333; text-align: center; color: #00ffcc; font-weight: bold; border-radius: 4px; }
        #timer-span { color: #ff4d4d; margin-left: 10px; }
        
        /* Modal giao diện theo hình */
        #modal-overlay { display: flex; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content: center; align-items: center; }
        .critical-error-box { width: 400px; background: #262626; border: 1px solid #444; color: white; border-radius: 5px; overflow: hidden; }
        .ce-header { background: #333; padding: 10px; font-size: 14px; font-weight: bold; display: flex; justify-content: space-between; border-bottom: 1px solid #444; }
        .ce-body { padding: 30px 20px; text-align: center; font-size: 16px; color: #00ffcc; }
        .ce-footer { padding: 15px; text-align: center; background: #1a1a1a; }
        .ce-btn { min-width: 120px; padding: 10px; border: none; cursor: pointer; margin: 5px; font-weight: bold; text-transform: uppercase; transition: 0.2s; }
        .btn-blue { background: #007acc; color: white; }
        .btn-gray { background: #444; color: #ccc; }
        .btn-red { background: #e74c3c; color: white; }
        .btn-blue:hover { background: #005f99; }
    </style>
</head>
<body>

    <div id="modal-overlay">
        <div id="custom-modal" class="critical-error-box">
            <div class="ce-header"><span id="ce-title">CHESS MASTER</span></div>
            <div class="ce-body" id="ce-msg">Chọn chế độ chơi để bắt đầu</div>
            <div class="ce-footer" id="ce-buttons">
                <button class="ce-btn btn-blue" onclick="prepareMatch('PVE')">NGƯỜI VS MÁY</button>
                <button class="ce-btn btn-gray" onclick="prepareMatch('PVP')">NGƯỜI VS NGƯỜI</button>
            </div>
        </div>
    </div>

    <div id="main-layout">
        <div>
            <div id="game-outer">
                <div id="board"></div>
                <div id="click-overlay"></div>
            </div>
            <div class="info-bar">
                <span id="status">LƯỢT ĐI: TRẮNG</span>
                <span id="timer-span">30s</span>
            </div>
        </div>
        <div id="logs-container">
            <div id="logs">> Hệ thống sẵn sàng.</div>
            <button class="ce-btn btn-red" style="width: 100%; margin-top: 10px;" onclick="confirmExit()">THOÁT TRẬN</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

    <script>
        var board = null, game = new Chess(), selectedSquare = null;
        var currentMode = 'PVE', myColor = 'w', timerValue = 30, timerInterval = null;
        var afkCount = { w: 0, b: 0 };

        function updateUI(title, msg, btns) {
            $('#ce-title').text(title); $('#ce-msg').text(msg);
            $('#ce-buttons').html(btns.map(b => `<button class="ce-btn ${b.cls}" onclick="${b.click}">${b.text}</button>`).join(''));
        }

        function prepareMatch(mode) {
            if (mode === 'PVE') {
                myColor = Math.random() > 0.5 ? 'w' : 'b';
                updateUI("THÔNG BÁO", "Đã vào trận với Máy!", [{text: "BẮT ĐẦU", click: "startGame('PVE')", cls: "btn-blue"}]);
            } else {
                let wait = 60;
                updateUI("GHÉP TRẬN", `Đang tìm đối thủ... (${wait}s)`, []);
                let si = setInterval(() => {
                    wait--; $('#ce-msg').text(`Đang tìm đối thủ... (${wait}s)`);
                    if (wait === 55) { // Giả lập tìm thấy đối thủ
                        clearInterval(si);
                        myColor = Math.random() > 0.5 ? 'w' : 'b';
                        updateUI("THÀNH CÔNG", "Đã tìm thấy đối thủ!", [{text: "VÀO TRẬN", click: "startGame('PVP')", cls: "btn-blue"}]);
                    }
                    if (wait <= 0) {
                        clearInterval(si);
                        updateUI("THẤT BẠI", "Không tìm thấy đối thủ.", [
                            {text: "THỬ LẠI", click: "prepareMatch('PVP')", cls: "btn-blue"},
                            {text: "CHƠI VỚI MÁY", click: "prepareMatch('PVE')", cls: "btn-gray"}
                        ]);
                    }
                }, 1000);
            }
        }

        function startGame(mode) {
            currentMode = mode;
            $('#modal-overlay').hide();
            $('#main-layout').css({'opacity': '1', 'pointer-events': 'auto'});
            
            board = Chessboard('board', {
                position: 'start', draggable: false,
                orientation: myColor === 'w' ? 'white' : 'black',
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            });

            game.reset(); afkCount = {w:0, b:0};
            initOverlay();
            addLog(`Trận đấu ${mode} bắt đầu. Bạn cầm quân ${myColor==='w'?'Trắng':'Đen'}`);
            startTimer();
        }

        function initOverlay() {
            const overlay = $('#click-overlay').empty();
            let squares = [];
            for(let i=1; i<=8; i++) ['a','b','c','d','e','f','g','h'].forEach(c => squares.push(c+i));
            if (myColor === 'w') squares.reverse();
            squares.forEach(sq => overlay.append(`<div class="click-cell" id="overlay-${sq}" data-sq="${sq}"></div>`));
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerValue = 30;
            $('#timer-span').text("30s");

            // AI Move Logic (5-10s)
            let aiTime = Math.floor(Math.random() * 6) + 5; // 5-10s

            timerInterval = setInterval(() => {
                timerValue--;
                $('#timer-span').text(timerValue + "s");

                // Logic máy đánh ở PVE
                if (currentMode === 'PVE' && game.turn() !== myColor && (30 - timerValue) >= aiTime) {
                    makeAiMove();
                    return;
                }

                if (timerValue <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 1000);
        }

        function handleTimeout() {
            let turn = game.turn();
            afkCount[turn]++;
            if (afkCount[turn] >= 5) {
                $('#modal-overlay').show();
                updateUI("CẢNH BÁO", "Đối thủ không còn chơi, bạn muốn thoát không?", [
                    {text: "THOÁT", click: "location.reload()", cls: "btn-red"},
                    {text: "TIẾP TỤC", click: "makeAiMove(); $('#modal-overlay').hide();", cls: "btn-gray"}
                ]);
            } else {
                makeAiMove();
            }
        }

        function makeAiMove() {
            let moves = game.moves();
            if (moves.length === 0) return;
            let move = moves[Math.floor(Math.random() * moves.length)];
            game.move(move);
            board.position(game.fen());
            addLog(`Máy: ${move}`);
            updateGameStatus();
        }

        $(document).on('click', '.click-cell', function() {
            if (game.turn() !== myColor && currentMode === 'PVP') return;
            const sq = $(this).data('sq');
            if (selectedSquare) {
                let move = game.move({ from: selectedSquare, to: sq, promotion: 'q' });
                if (move) {
                    addLog(`Bạn: ${move.from}-${move.to}`);
                    board.position(game.fen());
                    selectedSquare = null; clearBorders(); updateGameStatus();
                } else { selectPiece(sq); }
            } else { selectPiece(sq); }
        });

        function selectPiece(sq) {
            let p = game.get(sq);
            if (p && p.color === game.turn()) {
                selectedSquare = sq; clearBorders();
                $(`#overlay-${sq}`).addClass('border-selected');
                game.moves({square:sq, verbose:true}).forEach(m=>$(`#overlay-${m.to}`).addClass('border-hint'));
            } else { selectedSquare = null; clearBorders(); }
        }

        function updateGameStatus() {
            $('#status').text("LƯỢT ĐI: " + (game.turn()==='w'?"TRẮNG":"ĐEN"));
            if (game.game_over()) {
                clearInterval(timerInterval);
                updateUI("KẾT THÚC", "Trận đấu đã kết thúc!", [{text: "CHƠI LẠI", click: "location.reload()", cls: "btn-blue"}]);
                $('#modal-overlay').show();
            } else startTimer();
        }

        function addLog(m) { 
            $('#logs').append(`<div>> ${m}</div>`); 
            $('#logs').scrollTop($('#logs')[0].scrollHeight); 
        }

        function clearBorders() { $('.click-cell').removeClass('border-selected border-hint'); }

        function confirmExit() {
            clearInterval(timerInterval);
            $('#main-layout').css({'opacity': '0.3', 'pointer-events': 'none'});
            $('#modal-overlay').show();
            updateUI("CHESS MASTER", "Chọn chế độ chơi để bắt đầu", [
                {text: "NGƯỜI VS MÁY", click: "prepareMatch('PVE')", cls: "btn-blue"},
                {text: "NGƯỜI VS NGƯỜI", click: "prepareMatch('PVP')", cls: "btn-gray"}
            ]);
        }
    </script>
</body>
</html>
